name: Remote Desktop Access

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'Select Operating System'
        required: true
        type: choice
        options:
        - windows-latest
        - windows-11-arm
        - macos-latest
        - ubuntu-latest
        default: 'windows-latest'
      username:
        description: 'Custom Username'
        required: true
        type: string
        default: 'Ashik'
      tunnel_provider:
        description: 'Select Tunnel Provider'
        required: true
        type: choice
        options:
        - ngrok
        - cloudflare
        default: 'ngrok'
      region:
        description: 'Select Ngrok Tunnel Region (only for ngrok)'
        required: true
        type: choice
        options:
        - "us"
        - "eu"
        - "ap"
        - "au"
        - "sa"
        - "jp"
        - "in"
        default: 'in'
      timeout:
        description: 'Session Timeout (minutes, max 360)'
        required: true
        type: string
        default: '360'
      install_virtual_sound_card:
        description: 'Install Virtual Sound Card'
        required: false
        type: boolean
        default: false
      set_default_browser:
        description: 'Set Default Browser to Chrome (Windows only)'
        required: false
        type: string
        default: 'chrome'

jobs:
  remote-desktop:
    runs-on: ${{ github.event.inputs.os }}
    timeout-minutes: ${{ fromJSON(github.event.inputs.timeout) }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Windows pre-install
        if: contains(github.event.inputs.os, 'windows')
        env:
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ./scripts/preinstall-windows.ps1 -Username "${{ github.event.inputs.username }}" `
            -InstallVirtualSoundCard ${{ github.event.inputs.install_virtual_sound_card }} `
            -SetDefaultBrowser "${{ github.event.inputs.set_default_browser }}"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force
        shell: pwsh

      - name: Run macOS pre-install
        if: github.event.inputs.os == 'macos-latest'
        env:
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          chmod +x ./scripts/preinstall-mac.sh
          ./scripts/preinstall-mac.sh "${{ github.event.inputs.username }}" "${{ github.event.inputs.install_virtual_sound_card }}"

      - name: Run Ubuntu pre-install
        if: github.event.inputs.os == 'ubuntu-latest'
        env:
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
        run: |
          chmod +x ./scripts/preinstall-ubuntu.sh
          sudo USER_PASSWORD=$USER_PASSWORD ./scripts/preinstall-ubuntu.sh "${{ github.event.inputs.username }}" "${{ github.event.inputs.install_virtual_sound_card }}"

      - name: Install dependencies
        run: |
          if [[ "${{ github.event.inputs.os }}" == *"windows"* ]]; then
            mkdir -p /usr/local/bin
            curl -L -o /usr/local/bin/jq.exe https://github.com/stedolan/jq/releases/download/jq-1.6/jq-win64.exe
            chmod +x /usr/local/bin/jq.exe
          elif [[ "${{ github.event.inputs.os }}" == "macos-latest" ]]; then
            brew install jq
          else
            sudo apt-get update && sudo apt-get install -y jq
          fi
        shell: bash

      - name: Setup tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          chmod +x ./scripts/setup-tunnel.sh
          if [[ "${{ github.event.inputs.os }}" == "macos-latest" ]]; then
            PORT="5900"
          else
            PORT="3389"
          fi
          ./scripts/setup-tunnel.sh "${{ github.event.inputs.tunnel_provider }}" "${{ github.event.inputs.os }}" "$PORT" "${{ github.event.inputs.region }}" "$NGROK_AUTH_TOKEN"
        shell: bash

      - name: Display connection details
        run: |
          chmod +x ./scripts/display-connection.sh
          ./scripts/display-connection.sh "${{ github.event.inputs.tunnel_provider }}" "${{ github.event.inputs.os }}" "${{ env.RDP_ADDRESS }}" "${{ env.RDP_PORT }}" "${{ github.event.inputs.username }}" "${{ secrets.USER_PASSWORD }}"
        shell: bash

      - name: Keep session alive
        run: |
          echo "Remote desktop session is now active!"
          echo "The workflow will remain running for ${{ github.event.inputs.timeout }} minutes."
          sleep ${{ github.event.inputs.timeout }}m
        shell: bash

      - name: Cleanup
        if: always() && contains(github.event.inputs.os, 'windows') && github.event.inputs.tunnel_provider == 'cloudflare'
        run: taskkill /IM cloudflared.exe /F 2>nul || echo "cloudflared process not found"
        shell: bash
