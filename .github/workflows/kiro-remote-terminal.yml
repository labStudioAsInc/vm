name: Kiro Remote Terminal Access

on:
  workflow_dispatch:
    inputs:
      tunnel_provider:
        description: 'Tunnel provider to use'
        required: true
        default: 'cloudflare'
        type: choice
        options:
          - cloudflare
          - ngrok
      duration_hours:
        description: 'How long to keep tunnel alive (hours, max 6)'
        required: true
        default: '3'
        type: string

jobs:
  kiro-terminal:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install ttyd (web terminal)
        run: |
          wget -q https://github.com/tsl0922/ttyd/releases/download/1.7.4/ttyd.x86_64
          chmod +x ttyd.x86_64
          sudo mv ttyd.x86_64 /usr/local/bin/ttyd
          
      - name: Install Kiro CLI
        run: |
          # TODO: Add actual Kiro CLI installation commands
          # Example: npm install -g @amazon/kiro-cli
          echo "Kiro CLI installation placeholder"
          echo "Replace this with actual installation steps"
          
      - name: Setup Cloudflare Tunnel
        if: inputs.tunnel_provider == 'cloudflare'
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
      - name: Setup ngrok
        if: inputs.tunnel_provider == 'ngrok'
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install -y ngrok
          
      - name: Configure ngrok auth
        if: inputs.tunnel_provider == 'ngrok'
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -n "$NGROK_AUTH_TOKEN" ]; then
            ngrok config add-authtoken $NGROK_AUTH_TOKEN
          else
            echo "โ๏ธ  Warning: NGROK_AUTH_TOKEN not set. Using ngrok without auth (limited features)"
          fi
          
      - name: Start web terminal
        run: |
          echo "Starting ttyd web terminal on port 7681..."
          ttyd -p 7681 -W bash > /tmp/ttyd.log 2>&1 &
          sleep 3
          
          if pgrep -x "ttyd" > /dev/null; then
            echo "โ ttyd started successfully"
          else
            echo "โ ttyd failed to start"
            cat /tmp/ttyd.log
            exit 1
          fi
          
      - name: Start Cloudflare Quick Tunnel
        if: inputs.tunnel_provider == 'cloudflare'
        run: |
          echo "๐ Starting Cloudflare Quick Tunnel (no token needed)..."
          cloudflared tunnel --url http://localhost:7681 --no-autoupdate > /tmp/cloudflared.log 2>&1 &
          
          # Wait for tunnel URL to appear
          echo "โณ Waiting for tunnel URL..."
          for i in {1..30}; do
            if grep -q "https://" /tmp/cloudflared.log; then
              break
            fi
            sleep 1
          done
          
          # Extract and display the URL
          TUNNEL_URL=$(grep -oP 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/cloudflared.log | head -1)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ Cloudflare Quick Tunnel is LIVE!"
            echo "๐ Access your terminal at:"
            echo ""
            echo "    $TUNNEL_URL"
            echo ""
            echo "๐ก This is a temporary tunnel (no token required)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          else
            echo "โ Failed to get tunnel URL"
            cat /tmp/cloudflared.log
            exit 1
          fi
          
      - name: Start ngrok Tunnel
        if: inputs.tunnel_provider == 'ngrok'
        run: |
          echo "๐ Starting ngrok tunnel..."
          ngrok http 7681 --log=stdout > /tmp/ngrok.log 2>&1 &
          
          # Wait for tunnel to establish
          echo "โณ Waiting for ngrok tunnel..."
          sleep 5
          
          # Get the public URL from ngrok API
          TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | grep -oP '"public_url":"https://[^"]+' | head -1 | cut -d'"' -f4)
          
          if [ -n "$TUNNEL_URL" ]; then
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ ngrok Tunnel is LIVE!"
            echo "๐ Access your terminal at:"
            echo ""
            echo "    $TUNNEL_URL"
            echo ""
            echo "๐ ngrok dashboard: http://localhost:4040"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          else
            echo "โ Failed to get ngrok URL"
            cat /tmp/ngrok.log
            exit 1
          fi
          
      - name: Keep tunnel alive
        run: |
          DURATION_SECONDS=$((${DURATION_HOURS:-3} * 3600))
          echo "โฐ Keeping tunnel alive for ${DURATION_HOURS:-3} hours..."
          echo ""
          echo "๐ก Tips:"
          echo "   - Your workspace is at: $GITHUB_WORKSPACE"
          echo "   - To stop early, cancel this workflow run"
          echo "   - All changes will be lost when workflow ends"
          echo ""
          
          # Keep alive and show periodic status
          START_TIME=$(date +%s)
          while true; do
            ELAPSED=$(($(date +%s) - START_TIME))
            REMAINING=$((DURATION_SECONDS - ELAPSED))
            
            if [ $REMAINING -le 0 ]; then
              echo "โฑ๏ธ  Time's up! Shutting down..."
              break
            fi
            
            HOURS=$((REMAINING / 3600))
            MINUTES=$(((REMAINING % 3600) / 60))
            echo "โณ Time remaining: ${HOURS}h ${MINUTES}m"
            
            sleep 300  # Status update every 5 minutes
          done
          
      - name: Cleanup
        if: always()
        run: |
          echo "๐งน Cleaning up..."
          pkill ttyd || true
          pkill cloudflared || true
          pkill ngrok || true
          echo "โ Cleanup complete"
